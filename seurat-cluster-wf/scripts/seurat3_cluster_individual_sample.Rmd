---
title: Seurat Cluster Individual Sample
author: Justin Fear
date: 'Compiled: `r format(Sys.Date(), "%B %d, %Y")`'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(collapse=TRUE, warning=FALSE, message=FALSE, cache.lazy=FALSE,
                      bootstrap.show.code=FALSE, bootstrap.show.output=FALSE,
                      fig.ext='png')
```

```{r load_libraries, include=FALSE}
options(repr.plot.width=10, repr.plot.height=10)
library(Seurat)
library(dplyr)
library(yaml)
library(feather)
library(ggplot2)
set.seed(42)
```

```{r globals, include=FALSE, eval=TRUE}
SAMPLE <- 'testis1'
DATA_DIR <- '../../output/cellselection-wf/testis1'
GENE_ANNOTATION <-  '../../references/gene_annotation_dmel_r6-24.feather'
OUTDIR <- '~/tmp/seurat3'
REP <- 'rep1'

REFERENCES_DIR <- Sys.getenv('REFERENCES_DIR', '/data/LCDB/lcdb-references')
```

```{r}
fbgn2symbol <- read_feather('../../references/gene_annotation_dmel_r6-24.feather', columns=c("FBgn", "gene_symbol"))
```

### Load 10X Data
```{r load_10x_data}
tenX.data <- Read10X(data.dir = DATA_DIR, gene.column = 2)
sobj <- CreateSeuratObject(
    counts = tenX.data,
    min.cells = 3,
    min.features = 200,
    project = SAMPLE
)
```

```{r estimate_mito_content}
sobj[["percent.mt"]] <- PercentageFeatureSet(sobj, pattern = "^mt:")
```


```{r plot_dist_feature_cnts}
VlnPlot(sobj, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), pt.size = .1, ncol = 3)
```

```{r plot_feature_scatter}
p1 <- FeatureScatter(sobj, feature1 = "nCount_RNA", feature2 = "percent.mt") + scale_x_log10() + xlab("UMI")
p2 <- FeatureScatter(sobj, feature1 = "nCount_RNA", feature2 = "nFeature_RNA") + scale_x_log10() + xlab("UMI") + ylab("Number Genes")
CombinePlots(plots = list(p1, p2))
```

From this I have settled on a filter of:
* 200 < Number of Genes < 4,000
* percent.mt < 40

```{r filter_cells}
sobj <- subset(sobj, subset = nFeature_RNA > 200 & nFeature_RNA <= 4000 & percent.mt < 40)
```

### Normalization and Dimension Reduction
```{r normalize}
sobj <- NormalizeData(
    sobj,
    normalization.method = "LogNormalize",
    scale.factor = 1e4,
    display.progress = FALSE
)
```


```{r fig.width=12}
sobj <- FindVariableFeatures(sobj, selection.method = "vst", nfeatures = 2000)

top10 <- head(VariableFeatures(sobj), 10)

p1 <- VariableFeaturePlot(sobj)
p2 <- LabelPoints(plot = p1, points = top10, repel = TRUE)
CombinePlots(plots = list(p1, p2))
```

```{r scale_data}
all_genes <- rownames(sobj)
sobj <- ScaleData(sobj, features = all_genes, vars.to.regress = "percent.mt")
```

```{r dim_reduction}
sobj <- RunPCA(sobj, features = VariableFeatures(sobj), verbose = FALSE)
```

```{r}
print(sobj[["pca"]], dims=1:5, nfeatures = 10)
```

```{r fig.height=6}
VizDimLoadings(sobj, dims = 1:2, reduction = "pca")
```

```{r}
DimPlot(sobj, reduction = "pca")
```


```{r fig.height=20}
DimHeatmap(sobj, dims = 1:15, balanced = TRUE)
```



```{r}
sobj <- JackStraw(sobj, num.replicate = 100, dims = 30)
sobj <- ScoreJackStraw(sobj, dims = 1:30)
```



```{r fig.width=12}
p1 <- JackStrawPlot(sobj, dims=1:30)
p2 <- JackStrawPlot(sobj, dims=1:11)
CombinePlots(plots = list(p1, p2), ncol = 1)
```

```{r}
ElbowPlot(sobj)
```

Looking at all of the metrics I think 11 is a good metric.



### Clustering 

```{r}
sobj <- FindNeighbors(sobj, dims = 1:11)
sobj <- FindClusters(sobj, resolution = c(.4, .5, .6, .7, .8, .9, 1, 1.1, 1.2), verbose = FALSE)

diff_res <- sobj@meta.data %>% select(contains("res"))
for (i in 1:dim(diff_res)[[2]]){
    res <- diff_res[, i]
    name <- colnames(diff_res)[[i]]
    lvls <- levels(res)
    print(paste0(name, ':  ', length(lvls)))
}

sobj <- SetIdent(sobj, value = "RNA_snn_res.0.8")
```


```{r fig.asp=1}
sobj <- RunUMAP(sobj, dims = 1:11)
DimPlot(sobj, reduction = "umap")
```

```{r fig.asp=1}
sobj <- RunTSNE(sobj, dims = 1:11)
DimPlot(sobj, reduction = "tsne")
```

### Look at marker genes
```{r load_lit_genes}
lit_genes = yaml.load_file('../../config/literature_genes.yaml')
```

#### Spermatogonia
```{r plot_heatmap_gonia, fig.width=20, fig.height=20}
lg <- fbgn2symbol %>% filter(FBgn %in% lit_genes[['gonia']]) %>% pull("gene_symbol")
VlnPlot(sobj, features = lg)
FeaturePlot(sobj, features = lg)
```

#### Spermatocytes
```{r plot_heatmap_gonia, fig.width=20, fig.height=20}
lg <- fbgn2symbol %>% filter(FBgn %in% lit_genes[['spermatocytes']]) %>% pull("gene_symbol")
VlnPlot(sobj, features = lg)
FeaturePlot(sobj, features = lg)
```

#### CySC
```{r plot_heatmap_gonia, fig.width=20, fig.height=20}
lg <- fbgn2symbol %>% filter(FBgn %in% lit_genes[['cysc']]) %>% pull("gene_symbol")
VlnPlot(sobj, features = lg)
FeaturePlot(sobj, features = lg)
```

#### TE
```{r plot_heatmap_gonia, fig.width=20, fig.height=20}
lg <- fbgn2symbol %>% filter(FBgn %in% lit_genes[['te']]) %>% pull("gene_symbol")
VlnPlot(sobj, features = lg)
FeaturePlot(sobj, features = lg)
```

#### PC
```{r plot_heatmap_gonia, fig.width=8}
lg <- fbgn2symbol %>% filter(FBgn %in% lit_genes[['pigment']]) %>% pull("gene_symbol")
VlnPlot(sobj, features = lg)
FeaturePlot(sobj, features = lg)
```

#### hub
```{r plot_heatmap_gonia, fig.width=20, fig.height=20}
lg <- fbgn2symbol %>% filter(FBgn %in% lit_genes[['hub']]) %>% pull("gene_symbol")
VlnPlot(sobj, features = lg)
FeaturePlot(sobj, features = lg)
```







```{r}
biomarkers <- FindAllMarkers(sobj, only.pos = TRUE)
```

```{r}
top_markers <- biomarkers %>% filter(p_val_adj <= 0.001) %>% group_by(cluster) %>% top_n(n = 12, wt= avg_logFC)
```


```{r fig.width=20}
for (i in 0:12){
    features <- top_markers %>% filter(cluster == i) %>% pull(gene)
    p1 <- FeaturePlot(sobj, features = features)
    t1 <- grid::textGrob(paste0('Cluster: ', i), gp=grid::gpar(cex=3))
    gridExtra::grid.arrange(p1, top=t1)
}
```

from pathlib import Path

import pandas as pd

from larval_gonad.config import read_config

common_config = read_config('../config/common.yaml')
assembly = common_config['assembly']
tag = common_config['tag']

rule targets:
    input: 
        expand('../output/seurat-cluster-wf/{sample}/cluster_sample_low_end_cutoff.html', sample=['testis1'])


localrules: fbgn2chrom

rule fbgn2chrom:
    output: 
        '../output/fbgn2chrom.tsv'
    script: 
        '../bin/fbgn2chrom.py'


rule cluster_sample:
    input:
        rmd = 'scripts/cluster_sample_low_end_cutoff.Rmd',
        fbgn2chrom = rules.fbgn2chrom.output[0],
        data = '/home/fearjm/local_data_store/larval_gonad/output.bak/scrnaseq-wf/scrnaseq_samples/{sample}/outs/filtered_gene_bc_matrices/dm6.16/matrix.mtx'
#        data = f'../cellranger-wf/testis1/outs/filtered_gene_bc_matrices/{assembly}{tag}/matrix.mtx'
    output: 
        '../output/seurat-cluster-wf/{sample}/cluster_sample_low_end_cutoff.html'
    params:
        rep = lambda wildcards: 'rep' + wildcards.sample.replace('testis', '')
    resources:
        mem_gb=lambda wildcards, attempt: attempt * 16,
        time_hr=lambda wildcards, attempt: attempt * 8
    script: 'scripts/cluster_sample_low_end_cutoff.Rmd'


# """Run and render the RMarkdown file that performs differential expression"""
# rule combine_and_cluster_samples:
#     input:
#          mtx1=sorted(utils.flatten(c.targets['cellranger_force']['filtered_h5']))[:-1],
#          rmd='scripts/scrnaseq_combine_force.Rmd'
#     output:
#           html='../output/scrnaseq-wf/scrnaseq_combine_force/scrnaseq_combine_force.html',
#           robj='../output/scrnaseq-wf/scrnaseq_combine_force/seurat.Robj'
#     resources:
#         mem_gb=lambda wildcards, attempt: attempt * 16,
#         time_hr=lambda wildcards, attempt: attempt * 8
#     shell: """
#         Rscript -e "rmarkdown::render('{input.rmd}', 'knitrBootstrap::bootstrap_document')" && \
#         mv scripts/scrnaseq_combine_force.html {output.html}
#     """


# rule dump_seurat_object:
#     input: '{prefix}/seurat.sobj'
#     output:
#         '{prefix}/metadata.tsv',
#         '{prefix}/raw.tsv',
#         '{prefix}/normalized_read_counts.tsv',
#         '{prefix}/dispersion.tsv',
#         '{prefix}/var_genes.txt',
#         '{prefix}/scaled.tsv',
#         '{prefix}/principal_components_cell.tsv',
#         '{prefix}/principal_components_gene.tsv',
#         '{prefix}/principal_components_stdev.tsv',
#         '{prefix}/cca_cell.tsv',
#         '{prefix}/cca_gene.tsv',
#         '{prefix}/cca_gene_full.tsv',
#         '{prefix}/cca_aligned_cell.tsv',
#         '{prefix}/clusters.tsv',
#         '{prefix}/tsne.tsv'
#     resources:
#         mem_gb=lambda wildcards, attempt: attempt * 16,
#         time_hr=lambda wildcards, attempt: attempt * 8
#     script:
#         #TODO add script to dump sobj parts
#         ''


#     # TODO germ cell comparison